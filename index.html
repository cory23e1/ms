<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• Firebase –ß–∞—Ç</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #4285f4;
            --secondary-color: #34a853;
            --accent-color: #ea4335;
            --dark-color: #202124;
            --light-color: #f8f9fa;
            --gray-color: #dadce0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--dark-color);
        }

        .chat-app {
            width: 100%;
            max-width: 1000px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }

        /* –®–∞–ø–∫–∞ */
        .header {
            background: var(--dark-color);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: 600;
        }

        .logo i {
            color: var(--secondary-color);
        }

        .user-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #username {
            padding: 10px 15px;
            border: none;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            width: 200px;
            transition: all 0.3s;
        }

        #username:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            width: 250px;
        }

        #username::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        #status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #aaa;
        }

        #status i {
            font-size: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π */
        .users-sidebar {
            width: 250px;
            background: var(--light-color);
            border-right: 1px solid var(--gray-color);
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .users-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .users-title i {
            color: var(--primary-color);
        }

        #users-list {
            list-style: none;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: white;
            border-radius: 12px;
            border: 1px solid var(--gray-color);
            transition: all 0.3s;
            cursor: pointer;
        }

        .user-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow);
        }

        .user-item.active {
            border-color: var(--primary-color);
            background: rgba(66, 133, 244, 0.05);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 18px;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-status {
            font-size: 12px;
            color: #666;
        }

        .online {
            color: var(--secondary-color);
        }

        .offline {
            color: #999;
        }

        /* –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            padding: 20px 30px;
            border-bottom: 1px solid var(--gray-color);
            background: white;
            flex-shrink: 0;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-title i {
            color: var(--primary-color);
        }

        .chat-info {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 30px;
            background: #f5f7fb;
        }

        .message {
            display: flex;
            margin-bottom: 20px;
            max-width: 70%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            margin-left: auto;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .message.sent .message-avatar {
            margin-left: 12px;
        }

        .message.received .message-avatar {
            margin-right: 12px;
        }

        .message-content {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .message.sent .message-content {
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.received .message-content {
            background: white;
            border-bottom-left-radius: 4px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .message-sender {
            font-weight: 600;
            font-size: 13px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-left: 10px;
        }

        .message-text {
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message.sent .message-text {
            color: white;
        }

        /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ */
        .message-input-area {
            padding: 20px 30px;
            background: white;
            border-top: 1px solid var(--gray-color);
            flex-shrink: 0;
        }

        .input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        #message-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid var(--gray-color);
            border-radius: 50px;
            font-size: 14px;
            resize: none;
            line-height: 1.5;
            transition: all 0.3s;
            max-height: 120px;
        }

        #message-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }

        #send-btn {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        #send-btn:hover {
            background: var(--secondary-color);
            transform: scale(1.05);
        }

        #send-btn:active {
            transform: scale(0.95);
        }

        .input-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }

        .typing-indicator {
            font-style: italic;
            color: var(--primary-color);
            height: 18px;
        }

        /* –ü–æ–ª–æ—Å–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
        .messages-container::-webkit-scrollbar,
        .users-sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track,
        .users-sidebar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .messages-container::-webkit-scrollbar-thumb,
        .users-sidebar::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .chat-app {
                height: 95vh;
                border-radius: 15px;
            }
            
            .users-sidebar {
                display: none;
            }
            
            .message {
                max-width: 85%;
            }
            
            .header {
                padding: 15px;
            }
            
            .messages-container {
                padding: 15px;
            }
            
            .message-input-area {
                padding: 15px;
            }
            
            #username {
                width: 150px;
            }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        .online-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--secondary-color);
            border-radius: 50%;
            margin-right: 5px;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--dark-color);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification i {
            color: var(--secondary-color);
        }

        /* –ó–∞–≥—Ä—É–∑—á–∏–∫ */
        .loader {
            text-align: center;
            padding: 30px;
            color: #666;
        }

        .loader i {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--primary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="chat-app">
        <!-- –®–∞–ø–∫–∞ -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-fire"></i>
                <span>Firebase Chat</span>
            </div>
            <div class="user-controls">
                <input type="text" id="username" placeholder="–í–∞—à–µ –∏–º—è..." maxlength="20">
                <div id="status">
                    <i class="fas fa-circle"></i>
                    <span>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
            <div class="users-sidebar">
                <div class="users-title">
                    <i class="fas fa-users"></i>
                    <span>–û–Ω–ª–∞–π–Ω (<span id="online-count">0</span>)</span>
                </div>
                <ul id="users-list">
                    <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </ul>
            </div>

            <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
            <div class="chat-area">
                <div class="chat-header">
                    <div class="chat-title">
                        <i class="fas fa-comments"></i>
                        <span>–û–±—â–∏–π —á–∞—Ç</span>
                    </div>
                    <div class="chat-info">
                        –û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                    </div>
                </div>

                <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
                <div class="messages-container" id="messages-container">
                    <div class="loader" id="loader">
                        <i class="fas fa-spinner"></i>
                        <div>–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞...</div>
                    </div>
                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>

                <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
                <div class="message-input-area">
                    <div class="input-container">
                        <textarea 
                            id="message-input" 
                            placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                            rows="1"
                            maxlength="500"
                        ></textarea>
                        <button id="send-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="input-actions">
                        <div class="typing-indicator" id="typing-indicator"></div>
                        <div>
                            <span id="char-count">0</span>/500
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ====================
        // –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–ò –ù–ê–°–¢–†–û–ô–ö–ò –ù–ê –í–ê–®–ò!
        const firebaseConfig = {
            apiKey: "AIzaSyB5eIngl-CnWkSuKcNtywID7kdOKKCatXY",
            authDomain: "ms-adaptive-chat.firebaseapp.com",
            databaseURL: "https://ms-adaptive-chat-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "ms-adaptive-chat",
            storageBucket: "ms-adaptive-chat.firebasestorage.app",
            messagingSenderId: "571640671300",
            appId: "1:571640671300:web:e1e0f4369b93a3ef8f2011"
        };
        // ==============================================================

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentUser = null;
        let usersRef = null;
        let messagesRef = null;
        let typingRef = null;
        let currentUserId = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞
        function initChat() {
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            currentUserId = generateUserId();
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∏–∑ localStorage –∏–ª–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º
            let savedName = localStorage.getItem('chat_username');
            if (!savedName) {
                savedName = `–ì–æ—Å—Ç—å_${Math.floor(Math.random() * 1000)}`;
                localStorage.setItem('chat_username', savedName);
            }
            
            document.getElementById('username').value = savedName;
            currentUser = {
                id: currentUserId,
                name: savedName,
                isOnline: true,
                lastSeen: Date.now(),
                typing: false
            };
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Å—ã–ª–æ–∫ –Ω–∞ –¥–∞–Ω–Ω—ã–µ Firebase
            usersRef = database.ref('users');
            messagesRef = database.ref('messages');
            typingRef = database.ref('typing');
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            document.getElementById('username').addEventListener('input', function() {
                const newName = this.value.trim();
                if (newName) {
                    currentUser.name = newName;
                    localStorage.setItem('chat_username', newName);
                    updateUserInFirebase();
                }
            });
            
            // –°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤
            document.getElementById('message-input').addEventListener('input', function() {
                document.getElementById('char-count').textContent = this.value.length;
                handleTyping();
            });
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter (–±–µ–∑ Shift)
            document.getElementById('message-input').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
                
                // –ê–≤—Ç–æ—Ä–∞–∑–º–µ—Ä textarea
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            // –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            loadInitialData();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
            setupRealtimeListeners();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
            updateStatus('connected');
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(status) {
            const statusElement = document.getElementById('status');
            const icon = statusElement.querySelector('i');
            
            switch(status) {
                case 'connected':
                    statusElement.querySelector('span').textContent = '–í —Å–µ—Ç–∏';
                    icon.style.color = '#34a853';
                    icon.style.animation = 'pulse 2s infinite';
                    break;
                case 'connecting':
                    statusElement.querySelector('span').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                    icon.style.color = '#fbbc05';
                    icon.style.animation = 'pulse 1s infinite';
                    break;
                case 'disconnected':
                    statusElement.querySelector('span').textContent = '–û—Ç–∫–ª—é—á–µ–Ω–æ';
                    icon.style.color = '#ea4335';
                    icon.style.animation = 'none';
                    break;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        function loadInitialData() {
            // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 50 —Å–æ–æ–±—â–µ–Ω–∏–π
            messagesRef.limitToLast(50).once('value').then((snapshot) => {
                const messages = snapshot.val() || {};
                const messagesArray = Object.values(messages).sort((a, b) => a.timestamp - b.timestamp);
                
                document.getElementById('loader').style.display = 'none';
                
                messagesArray.forEach(message => {
                    displayMessage(message);
                });
                
                scrollToBottom();
            });
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firebase
            updateUserInFirebase();
            
            // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
            window.addEventListener('beforeunload', () => {
                if (currentUser) {
                    usersRef.child(currentUserId).update({
                        isOnline: false,
                        lastSeen: Date.now()
                    });
                    
                    typingRef.child(currentUserId).remove();
                }
            });
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
        function setupRealtimeListeners() {
            // –°–ª—É—à–∞—Ç–µ–ª—å –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            messagesRef.limitToLast(1).on('child_added', (snapshot) => {
                const message = snapshot.val();
                if (message.userId !== currentUserId) {
                    displayMessage(message);
                    scrollToBottom();
                    showNotification(`${message.username}: ${message.text.substring(0, 30)}...`);
                }
            });
            
            // –°–ª—É—à–∞—Ç–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω
            usersRef.on('value', (snapshot) => {
                const users = snapshot.val() || {};
                updateUsersList(users);
            });
            
            // –°–ª—É—à–∞—Ç–µ–ª—å –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
            typingRef.on('value', (snapshot) => {
                const typers = snapshot.val() || {};
                updateTypingIndicator(typers);
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firebase
        function updateUserInFirebase() {
            if (!currentUser) return;
            
            usersRef.child(currentUserId).set({
                ...currentUser,
                lastSeen: Date.now()
            });
            
            // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
            usersRef.child(currentUserId).onDisconnect().update({
                isOnline: false,
                lastSeen: Date.now()
            });
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text || !currentUser) return;
            
            // –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            const message = {
                id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                text: text,
                username: currentUser.name,
                userId: currentUserId,
                timestamp: Date.now(),
                time: new Date().toLocaleTimeString([], { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                })
            };
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Firebase
            messagesRef.push(message);
            
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            displayMessage(message, true);
            
            // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è –≤–≤–æ–¥–∞
            input.value = '';
            input.style.height = 'auto';
            document.getElementById('char-count').textContent = '0';
            
            // –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
            typingRef.child(currentUserId).remove();
            
            scrollToBottom();
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function displayMessage(message, isSentByMe = false) {
            if (isSentByMe) {
                isSentByMe = message.userId === currentUserId;
            }
            
            const messagesContainer = document.getElementById('messages-container');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `message ${isSentByMe ? 'sent' : 'received'}`;
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    ${getInitials(message.username)}
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">${escapeHtml(message.username)}</span>
                        <span class="message-time">${message.time}</span>
                    </div>
                    <div class="message-text">${formatMessageText(message.text)}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function updateUsersList(users) {
            const usersList = document.getElementById('users-list');
            const onlineCountElement = document.getElementById('online-count');
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            const onlineUsers = Object.values(users).filter(user => user.isOnline);
            const offlineUsers = Object.values(users).filter(user => !user.isOnline);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            onlineCountElement.textContent = onlineUsers.length;
            
            // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
            usersList.innerHTML = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            onlineUsers.forEach(user => {
                if (user.id === currentUserId) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                
                const userItem = document.createElement('li');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                    <div class="user-avatar">
                        ${getInitials(user.name)}
                    </div>
                    <div class="user-info">
                        <div class="user-name">${escapeHtml(user.name)}</div>
                        <div class="user-status online">
                            <span class="online-indicator"></span>
                            –æ–Ω–ª–∞–π–Ω
                        </div>
                    </div>
                `;
                
                usersList.appendChild(userItem);
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
            if (offlineUsers.length > 0) {
                const divider = document.createElement('div');
                divider.style.margin = '20px 0 10px';
                divider.style.fontSize = '12px';
                divider.style.color = '#999';
                divider.textContent = '–ù–µ –≤ —Å–µ—Ç–∏';
                usersList.appendChild(divider);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ñ–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            offlineUsers.forEach(user => {
                const userItem = document.createElement('li');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                    <div class="user-avatar" style="opacity: 0.6;">
                        ${getInitials(user.name)}
                    </div>
                    <div class="user-info">
                        <div class="user-name" style="opacity: 0.6;">${escapeHtml(user.name)}</div>
                        <div class="user-status offline">
                            –±—ã–ª(–∞) ${formatLastSeen(user.lastSeen)}
                        </div>
                    </div>
                `;
                
                usersList.appendChild(userItem);
            });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
        let typingTimeout = null;
        function handleTyping() {
            const input = document.getElementById('message-input');
            
            if (input.value.trim()) {
                if (!currentUser.typing) {
                    currentUser.typing = true;
                    typingRef.child(currentUserId).set({
                        username: currentUser.name,
                        timestamp: Date.now()
                    });
                }
                
                // –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞
                if (typingTimeout) clearTimeout(typingTimeout);
                
                // –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è
                typingTimeout = setTimeout(() => {
                    currentUser.typing = false;
                    typingRef.child(currentUserId).remove();
                }, 3000);
            } else {
                currentUser.typing = false;
                typingRef.child(currentUserId).remove();
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
        function updateTypingIndicator(typers) {
            const indicator = document.getElementById('typing-indicator');
            const currentTypers = Object.values(typers)
                .filter(typer => typer.username !== currentUser.name)
                .filter(typer => Date.now() - typer.timestamp < 3000);
            
            if (currentTypers.length > 0) {
                const names = currentTypers.map(t => t.username).join(', ');
                indicator.textContent = `${names} ${currentTypers.length === 1 ? '–ø–µ—á–∞—Ç–∞–µ—Ç...' : '–ø–µ—á–∞—Ç–∞—é—Ç...'}`;
            } else {
                indicator.textContent = '';
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }

        function formatMessageText(text) {
            // –ü—Ä–æ—Å—Ç–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Å—ã–ª–æ–∫
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return escapeHtml(text).replace(urlRegex, url => 
                `<a href="${url}" target="_blank" style="color: #4285f4; text-decoration: underline;">${url}</a>`
            );
        }

        function formatLastSeen(timestamp) {
            const diff = Date.now() - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (minutes < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (minutes < 60) return `${minutes} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            if (hours < 24) return `${hours} —á –Ω–∞–∑–∞–¥`;
            return `${days} –¥–Ω –Ω–∞–∑–∞–¥`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottom() {
            const container = document.getElementById('messages-container');
            container.scrollTop = container.scrollHeight;
        }

        function showNotification(text) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–∫—Ç–∏–≤–Ω–∞ –ª–∏ –≤–∫–ª–∞–¥–∫–∞
            if (document.hidden) {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                if (Notification.permission === 'granted') {
                    new Notification('–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', {
                        body: text,
                        icon: 'https://firebase.google.com/static/images/brand-guidelines/logo-logomark.png'
                    });
                }
            }
            
            // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <i class="fas fa-comment-alt"></i>
                <span>${text}</span>
            `;
            
            document.body.appendChild(notification);
            
            // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        if ('Notification' in window) {
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
            if (firebaseConfig.apiKey.includes('–í–ê–®')) {
                alert('‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ Firebase!\n\n1. –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –Ω–∞ console.firebase.google.com\n2. –î–æ–±–∞–≤—å—Ç–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\n3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ –∫–æ–¥');
                document.getElementById('status').innerHTML = '<i class="fas fa-exclamation-triangle"></i> –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Firebase';
            } else {
                initChat();
            }
        });
    </script>
</body>
</html>