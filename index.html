<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• Advanced Chat - GitHub Pages</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <style>
        /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --accent: #f72585;
            --success: #4cc9f0;
            --warning: #f8961e;
            --danger: #e63946;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --gray: #6c757d;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .navbar {
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #4361ee, #f72585);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-links {
            display: flex;
            gap: 25px;
            list-style: none;
        }

        .nav-link {
            color: var(--light);
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(67, 97, 238, 0.2);
            color: #fff;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 3px solid var(--primary);
            cursor: pointer;
            object-fit: cover;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        .container {
            margin-top: 80px;
            padding: 20px;
            min-height: calc(100vh - 80px);
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        /* –ß–∞—Ç */
        .chat-container {
            display: flex;
            gap: 20px;
            height: 70vh;
        }

        .chat-sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 70%;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-content {
            background: rgba(67, 97, 238, 0.2);
            padding: 15px;
            border-radius: 15px;
            border-top-left-radius: 0;
        }

        .message.sent .message-content {
            background: rgba(76, 201, 240, 0.3);
            border-top-left-radius: 15px;
            border-top-right-radius: 0;
        }

        .message-attachment {
            margin-top: 10px;
            max-width: 300px;
        }

        .attachment-image {
            max-width: 100%;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .attachment-image:hover {
            transform: scale(1.02);
        }

        .chat-input {
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 10px;
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--dark);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å */
        .admin-panel {
            background: rgba(229, 57, 70, 0.1);
            border: 1px solid var(--danger);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .chat-container {
                flex-direction: column;
                height: auto;
            }
            .chat-sidebar {
                width: 100%;
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
    <nav class="navbar">
        <div class="logo">
            <i class="fas fa-fire"></i>
            <span>Advanced Chat</span>
        </div>
        
        <ul class="nav-links">
            <li><a href="#" class="nav-link active" data-tab="main-chat"><i class="fas fa-comments"></i> –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</a></li>
            <li><a href="#" class="nav-link" data-tab="events"><i class="fas fa-calendar-alt"></i> –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</a></li>
            <li><a href="#" class="nav-link" data-tab="tasks"><i class="fas fa-tasks"></i> –ó–∞–¥–∞–Ω–∏—è</a></li>
            <li><a href="#" class="nav-link" data-tab="adaptation"><i class="fas fa-graduation-cap"></i> –ê–¥–∞–ø—Ç–∞—Ü–∏—è</a></li>
        </ul>
        
        <div class="user-menu">
            <img src="https://ui-avatars.com/api/?name=–ì–æ—Å—Ç—å&background=4361ee&color=fff" 
                 alt="–ê–≤–∞—Ç–∞—Ä" 
                 class="user-avatar"
                 id="current-avatar"
                 onclick="openProfileModal()">
        </div>
    </nav>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="container">
        <!-- –í–∫–ª–∞–¥–∫–∞: –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç -->
        <div class="tab-content active" id="main-chat">
            <div class="card">
                <div class="chat-container">
                    <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
                    <div class="chat-sidebar">
                        <h3 class="mb-15"><i class="fas fa-users"></i> –ß–∞—Ç—ã</h3>
                        <div class="users-list" id="chats-list"></div>
                    </div>
                    
                    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
                    <div class="chat-main">
                        <div class="chat-header">
                            <h3 id="current-chat-title">–û–±—â–∏–π —á–∞—Ç</h3>
                        </div>
                        
                        <div class="chat-messages" id="chat-messages"></div>
                        
                        <div class="chat-input">
                            <button class="attachment-btn" onclick="openAttachmentModal()">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <textarea class="message-input" 
                                      id="message-input" 
                                      placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                                      rows="1"></textarea>
                            <button class="btn btn-primary" onclick="sendMessage()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å -->
            <div class="admin-panel" id="admin-panel" style="display: none;"></div>
        </div>

        <!-- –î—Ä—É–≥–∏–µ –≤–∫–ª–∞–¥–∫–∏ -->
        <div class="tab-content" id="events">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π -->
        </div>
        
        <div class="tab-content" id="tasks">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –∑–∞–¥–∞–Ω–∏–π -->
        </div>
        
        <div class="tab-content" id="adaptation">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ -->
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div class="modal" id="profile-modal">
        <div class="modal-content">
            <h2 class="mb-20"><i class="fas fa-user-edit"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h2>
            
            <div class="form-group">
                <label class="form-label">–ê–≤–∞—Ç–∞—Ä</label>
                <div class="d-flex align-center gap-15 mb-10">
                    <img src="https://ui-avatars.com/api/?name=–ì–æ—Å—Ç—å&background=4361ee&color=fff" 
                         alt="–ê–≤–∞—Ç–∞—Ä" 
                         class="user-avatar"
                         id="avatar-preview">
                    <button class="btn btn-outline" onclick="document.getElementById('avatar-upload').click()">
                        <i class="fas fa-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å
                    </button>
                    <input type="file" 
                           id="avatar-upload" 
                           accept="image/*" 
                           style="display: none;"
                           onchange="uploadAvatar(this.files[0])">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">–ù–∏–∫–Ω–µ–π–º</label>
                <input type="text" class="form-control" id="profile-username" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫–Ω–µ–π–º">
            </div>
            
            <div class="form-group">
                <label class="form-label">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                <select class="select-control" id="profile-role">
                    <option value="–ù–æ–≤–∏—á–æ–∫">–ù–æ–≤–∏—á–æ–∫</option>
                    <option value="–°–æ—Ç—Ä—É–¥–Ω–∏–∫">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</option>
                    <option value="–ú–µ–Ω–µ–¥–∂–µ—Ä">–ú–µ–Ω–µ–¥–∂–µ—Ä</option>
                    <option value="–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å">–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</option>
                    <option value="–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                </select>
            </div>
            
            <div class="d-flex justify-between mt-20">
                <button class="btn btn-outline" onclick="closeProfileModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤–ª–æ–∂–µ–Ω–∏–π -->
    <div class="modal" id="attachment-modal">
        <div class="modal-content">
            <h2 class="mb-20"><i class="fas fa-paperclip"></i> –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª</h2>
            
            <div class="form-group">
                <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –≤–ª–æ–∂–µ–Ω–∏—è:</label>
                <div class="d-flex gap-10 mb-20">
                    <button class="btn btn-outline" onclick="selectAttachmentType('image')">
                        <i class="fas fa-image"></i> –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    </button>
                    <button class="btn btn-outline" onclick="selectAttachmentType('gif')">
                        <i class="fas fa-photo-video"></i> GIF
                    </button>
                    <button class="btn btn-outline" onclick="selectAttachmentType('video')">
                        <i class="fas fa-video"></i> –í–∏–¥–µ–æ
                    </button>
                    <button class="btn btn-outline" onclick="selectAttachmentType('file')">
                        <i class="fas fa-file"></i> –§–∞–π–ª
                    </button>
                </div>
            </div>
            
            <div class="form-group" id="attachment-preview" style="display: none;">
                <label class="form-label">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä:</label>
                <div id="preview-container" class="mb-10"></div>
            </div>
            
            <div class="form-group">
                <label class="form-label" id="file-upload-label">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª:</label>
                <input type="file" 
                       class="form-control" 
                       id="file-upload"
                       onchange="previewAttachment(this.files[0])">
                <small class="text-muted" id="file-size-limit">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB</small>
            </div>
            
            <div class="d-flex justify-between mt-20">
                <button class="btn btn-outline" onclick="closeAttachmentModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="attachFile()">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
    <div class="modal" id="image-viewer">
        <div class="modal-content" style="max-width: 90vw; max-height: 90vh; background: transparent; padding: 0;">
            <img src="" alt="" id="full-image" style="width: 100%; height: auto; border-radius: 10px;">
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyB5eIngl-CnWkSuKcNtywID7kdOKKCatXY",
            authDomain: "ms-adaptive-chat.firebaseapp.com",
            databaseURL: "https://ms-adaptive-chat-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "ms-adaptive-chat",
            storageBucket: "ms-adaptive-chat.firebasestorage.app",
            messagingSenderId: "571640671300",
            appId: "1:571640671300:web:e1e0f4369b93a3ef8f2011"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase (—Ç–æ–ª—å–∫–æ Database)
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let currentUser = null;
        let currentChat = 'general';
        let currentAttachment = null;
        let attachmentType = 'image';

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        document.addEventListener('DOMContentLoaded', function() {
            loadProfile();
            initNavigation();
            loadChats();
            checkAdminStatus();
        });

        // ========== –ü–†–û–§–ò–õ–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ==========
        function loadProfile() {
            const savedProfile = localStorage.getItem('chat_profile');
            if (savedProfile) {
                currentUser = JSON.parse(savedProfile);
                updateProfileUI();
            } else {
                currentUser = {
                    id: generateUserId(),
                    username: '–ì–æ—Å—Ç—å',
                    role: '–ù–æ–≤–∏—á–æ–∫',
                    avatar: null,
                    points: 0
                };
            }
        }

        function saveProfile() {
            const username = document.getElementById('profile-username').value.trim();
            const role = document.getElementById('profile-role').value;
            const avatar = document.getElementById('avatar-preview').src;

            currentUser.username = username;
            currentUser.role = role;
            currentUser.avatar = avatar;

            localStorage.setItem('chat_profile', JSON.stringify(currentUser));
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
            database.ref('users/' + currentUser.id).set(currentUser);
            
            updateProfileUI();
            closeProfileModal();
            showNotification('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
        }

        function uploadAvatar(file) {
            if (!file) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showNotification('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º 2MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                // –°–∂–∏–º–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                compressImage(e.target.result, 200, 200).then(compressed => {
                    document.getElementById('avatar-preview').src = compressed;
                });
            };
            reader.readAsDataURL(file);
        }

        // ========== –°–ñ–ê–¢–ò–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô ==========
        function compressImage(dataUrl, maxWidth, maxHeight) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã
                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // –ö–∞—á–µ—Å—Ç–≤–æ 0.8 –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ –º–µ–∂–¥—É –∫–∞—á–µ—Å—Ç–≤–æ–º –∏ —Ä–∞–∑–º–µ—Ä–æ–º
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.src = dataUrl;
            });
        }

        // ========== –í–õ–û–ñ–ï–ù–ò–Ø BASE64 ==========
        function selectAttachmentType(type) {
            attachmentType = type;
            const input = document.getElementById('file-upload');
            const label = document.getElementById('file-upload-label');
            const sizeLimit = document.getElementById('file-size-limit');
            
            switch(type) {
                case 'image':
                    input.accept = 'image/*';
                    label.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:';
                    sizeLimit.textContent = '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 1MB)';
                    break;
                case 'gif':
                    input.accept = '.gif,image/gif';
                    label.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å GIF:';
                    sizeLimit.textContent = '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 3MB';
                    break;
                case 'video':
                    input.accept = 'video/*';
                    label.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ:';
                    sizeLimit.textContent = '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB (–∫–æ—Ä–æ—Ç–∫–∏–µ –≤–∏–¥–µ–æ)';
                    break;
                case 'file':
                    input.accept = '*/*';
                    label.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª:';
                    sizeLimit.textContent = '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 2MB';
                    break;
            }
        }

        function previewAttachment(file) {
            if (!file) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
            let maxSize = 5 * 1024 * 1024; // 5MB –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            switch(attachmentType) {
                case 'gif': maxSize = 3 * 1024 * 1024; break;
                case 'file': maxSize = 2 * 1024 * 1024; break;
            }
            
            if (file.size > maxSize) {
                showNotification(`–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º ${maxSize/1024/1024}MB`, 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const dataUrl = e.target.result;
                const previewContainer = document.getElementById('preview-container');
                previewContainer.innerHTML = '';
                
                if (attachmentType === 'image' || attachmentType === 'gif') {
                    // –î–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ GIF –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                    previewContainer.innerHTML = `
                        <img src="${dataUrl}" style="max-width: 200px; border-radius: 10px;">
                        <div class="text-muted mt-5">–†–∞–∑–º–µ—Ä: ${(file.size/1024).toFixed(2)}KB</div>
                    `;
                } else if (attachmentType === 'video') {
                    // –î–ª—è –≤–∏–¥–µ–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–µ–µ—Ä
                    previewContainer.innerHTML = `
                        <video controls style="max-width: 200px; border-radius: 10px;">
                            <source src="${dataUrl}" type="${file.type}">
                        </video>
                        <div class="text-muted mt-5">–†–∞–∑–º–µ—Ä: ${(file.size/1024).toFixed(2)}KB</div>
                    `;
                } else {
                    // –î–ª—è —Ñ–∞–π–ª–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∫–æ–Ω–∫—É
                    previewContainer.innerHTML = `
                        <div class="attachment-file">
                            <i class="fas fa-file fa-3x"></i>
                            <div class="mt-10">
                                <div><strong>${file.name}</strong></div>
                                <div class="text-muted">${(file.size/1024).toFixed(2)}KB</div>
                            </div>
                        </div>
                    `;
                }
                
                currentAttachment = {
                    type: attachmentType,
                    data: dataUrl,
                    name: file.name,
                    size: file.size
                };
                
                document.getElementById('attachment-preview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function attachFile() {
            if (!currentAttachment) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!', 'warning');
                return;
            }
            
            closeAttachmentModal();
            showNotification('–§–∞–π–ª –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω!');
        }

        // ========== –ß–ê–¢ ==========
        function loadChats() {
            database.ref('chats').on('value', snapshot => {
                const chats = snapshot.val() || {};
                const chatsList = document.getElementById('chats-list');
                chatsList.innerHTML = '';

                // –û–±—â–∏–π —á–∞—Ç
                const generalChat = document.createElement('div');
                generalChat.className = `user-item ${currentChat === 'general' ? 'active' : ''}`;
                generalChat.innerHTML = `
                    <div class="user-item-avatar" style="background: linear-gradient(135deg, #4361ee, #3a0ca3);">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="user-item-info">
                        <div class="user-item-name">–û–±—â–∏–π —á–∞—Ç</div>
                    </div>
                `;
                generalChat.onclick = () => switchChat('general', '–û–±—â–∏–π —á–∞—Ç');
                chatsList.appendChild(generalChat);

                // –ì—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã
                Object.entries(chats).forEach(([chatId, chat]) => {
                    if (chat.type === 'group') {
                        const chatElement = document.createElement('div');
                        chatElement.className = `user-item ${currentChat === chatId ? 'active' : ''}`;
                        chatElement.innerHTML = `
                            <div class="user-item-avatar" style="background: linear-gradient(135deg, #f72585, #b5179e);">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="user-item-info">
                                <div class="user-item-name">${chat.name}</div>
                            </div>
                        `;
                        chatElement.onclick = () => switchChat(chatId, chat.name);
                        chatsList.appendChild(chatElement);
                    }
                });
            });

            loadMessages();
        }

        function switchChat(chatId, title) {
            currentChat = chatId;
            document.getElementById('current-chat-title').textContent = title;
            loadMessages();
        }

        function loadMessages() {
            database.ref(`messages/${currentChat}`).on('value', snapshot => {
                const messages = snapshot.val() || {};
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.innerHTML = '';

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                const sortedMessages = Object.values(messages).sort((a, b) => a.timestamp - b.timestamp);

                sortedMessages.forEach(message => {
                    const isCurrentUser = message.userId === currentUser.id;
                    const messageElement = createMessageElement(message, isCurrentUser);
                    messagesContainer.appendChild(messageElement);
                });

                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }

        function createMessageElement(message, isCurrentUser) {
            const div = document.createElement('div');
            div.className = `message ${isCurrentUser ? 'sent' : 'received'}`;
            
            let attachmentHtml = '';
            if (message.attachment) {
                if (message.attachment.type === 'image' || message.attachment.type === 'gif') {
                    attachmentHtml = `
                        <div class="message-attachment">
                            <img src="${message.attachment.data}" 
                                 alt="${message.attachment.name}" 
                                 class="attachment-image"
                                 onclick="viewImage('${message.attachment.data}')"
                                 style="max-width: 250px; max-height: 250px; object-fit: contain;">
                            <div class="text-muted mt-2" style="font-size: 12px;">
                                ${message.attachment.name} (${(message.attachment.size/1024).toFixed(1)}KB)
                            </div>
                        </div>
                    `;
                } else if (message.attachment.type === 'video') {
                    attachmentHtml = `
                        <div class="message-attachment">
                            <video controls style="max-width: 300px; border-radius: 10px;">
                                <source src="${message.attachment.data}" type="video/mp4">
                            </video>
                            <div class="text-muted mt-2" style="font-size: 12px;">
                                ${message.attachment.name} (${(message.attachment.size/1024).toFixed(1)}KB)
                            </div>
                        </div>
                    `;
                } else {
                    attachmentHtml = `
                        <div class="message-attachment">
                            <a href="${message.attachment.data}" 
                               download="${message.attachment.name}"
                               class="attachment-file">
                                <i class="fas fa-file-download"></i>
                                <span>${message.attachment.name} (${(message.attachment.size/1024).toFixed(1)}KB)</span>
                            </a>
                        </div>
                    `;
                }
            }

            div.innerHTML = `
                <div class="message-content">
                    <div class="message-header">
                        <div>
                            <span class="message-sender">${message.username}</span>
                            <span class="message-role">${message.userRole}</span>
                        </div>
                        <div class="message-time">${formatTime(message.timestamp)}</div>
                    </div>
                    <div class="message-text">${message.text}</div>
                    ${attachmentHtml}
                    ${currentUser.username === 'admin' ? `
                        <button class="btn btn-danger btn-sm mt-10" onclick="deleteMessage('${message.id}')">
                            <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                        </button>
                    ` : ''}
                </div>
            `;

            return div;
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();

            if (!text && !currentAttachment) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª!', 'warning');
                return;
            }

            const message = {
                id: generateMessageId(),
                text: text || '',
                userId: currentUser.id,
                username: currentUser.username,
                userRole: currentUser.role,
                userAvatar: currentUser.avatar,
                timestamp: Date.now(),
                attachment: currentAttachment
            };

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
            database.ref(`messages/${currentChat}/${message.id}`).set(message)
                .then(() => {
                    input.value = '';
                    currentAttachment = null;
                    input.focus();
                    showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏!', 'error');
                });
        }

        // ========== –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ ==========
        function checkAdminStatus() {
            const adminPanel = document.getElementById('admin-panel');
            if (currentUser.username === 'admin') {
                adminPanel.style.display = 'block';
                adminPanel.innerHTML = `
                    <h3><i class="fas fa-shield-alt"></i> –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</h3>
                    <div class="admin-actions">
                        <button class="btn btn-danger" onclick="deleteAllMessages()">
                            <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                        </button>
                        <button class="btn btn-warning" onclick="clearDatabase()">
                            <i class="fas fa-database"></i> –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –±–∞–∑—É
                        </button>
                    </div>
                `;
            }
        }

        function deleteMessage(messageId) {
            if (currentUser.username !== 'admin') return;
            
            Swal.fire({
                title: '–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '–£–¥–∞–ª–∏—Ç—å',
                cancelButtonText: '–û—Ç–º–µ–Ω–∞'
            }).then((result) => {
                if (result.isConfirmed) {
                    database.ref(`messages/${currentChat}/${messageId}`).remove();
                    showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ!');
                }
            });
        }

        function deleteAllMessages() {
            if (currentUser.username !== 'admin') return;
            
            Swal.fire({
                title: '–£–¥–∞–ª–∏—Ç—å –í–°–ï —Å–æ–æ–±—â–µ–Ω–∏—è?',
                text: '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!',
                icon: 'error',
                showCancelButton: true,
                confirmButtonText: '–£–¥–∞–ª–∏—Ç—å –≤—Å—ë',
                cancelButtonText: '–û—Ç–º–µ–Ω–∞'
            }).then((result) => {
                if (result.isConfirmed) {
                    database.ref('messages').remove();
                    showNotification('–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω—ã!');
                }
            });
        }

        function clearDatabase() {
            if (currentUser.username !== 'admin') return;
            
            Swal.fire({
                title: '–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö?',
                text: '–£–¥–∞–ª—è—Ç—Å—è –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏!',
                icon: 'error',
                showCancelButton: true,
                confirmButtonText: '–û—á–∏—Å—Ç–∏—Ç—å',
                cancelButtonText: '–û—Ç–º–µ–Ω–∞'
            }).then((result) => {
                if (result.isConfirmed) {
                    database.ref().remove();
                    showNotification('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—á–∏—â–µ–Ω–∞!');
                }
            });
        }

        // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function generateMessageId() {
            return 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        function showNotification(text, type = 'success') {
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: type,
                title: text,
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        }

        function viewImage(dataUrl) {
            document.getElementById('full-image').src = dataUrl;
            document.getElementById('image-viewer').classList.add('active');
        }

        function openProfileModal() {
            document.getElementById('profile-modal').classList.add('active');
            document.getElementById('profile-username').value = currentUser.username;
            document.getElementById('profile-role').value = currentUser.role;
            document.getElementById('avatar-preview').src = currentUser.avatar || 
                'https://ui-avatars.com/api/?name=' + currentUser.username + '&background=4361ee&color=fff';
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').classList.remove('active');
        }

        function openAttachmentModal() {
            document.getElementById('attachment-modal').classList.add('active');
            selectAttachmentType('image'); // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        }

        function closeAttachmentModal() {
            document.getElementById('attachment-modal').classList.remove('active');
            document.getElementById('attachment-preview').style.display = 'none';
            document.getElementById('preview-container').innerHTML = '';
            document.getElementById('file-upload').value = '';
            currentAttachment = null;
        }

        function initNavigation() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                    
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }

        function updateProfileUI() {
            const avatar = document.getElementById('current-avatar');
            avatar.src = currentUser.avatar || 
                'https://ui-avatars.com/api/?name=' + currentUser.username + '&background=4361ee&color=fff';
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ Enter
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã—Å–æ—Ç–æ–π textarea
        document.getElementById('message-input').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    </script>
</body>
</html>
